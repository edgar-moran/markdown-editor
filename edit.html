<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>â˜¢</title>
<!-- INCLUDE_START -->
<link rel="icon" type="image/x-icon" href="favicon.ico">
<link rel="stylesheet" title="original" href="css/style.css">
<link rel="alternate stylesheet" title="normalize" href="css/normalize.css">
<link rel="alternate stylesheet" title="github" href="css/github.css">
<link rel="alternate stylesheet" title="gitlab" href="css/gitlab.css">
<link rel="stylesheet" href="css/highlight.css">
<script type="text/javascript" src="js/base64.min.js"></script>
<script type="text/javascript" src="js/crc32.min.js"></script>
<script type="text/javascript" src="js/vue.min.js"></script>
<script type="text/javascript" src="js/marked.min.js"></script>
<script type="text/javascript" src="js/showdown.min.js"></script>
<script type="text/javascript" src="js/sweetalert2.all.min.js"></script>
<script type="text/javascript" src="js/lodash.min.js"></script>
<script type="text/javascript" src="js/highlight.min.js"></script>
<script type="text/javascript" src="js/com.js"></script>
<script type="text/javascript" src="js/sjcl.js"></script>
<!-- INCLUDE_END -->

<script>hljs.initHighlightingOnLoad();</script>
<script type="text/javascript">
var separator = "#/" ;
var style_list = [ "original", "github", "gitlab", "normalize" ] ;
var style = "original" ;
var highlightjs = true ;
var engine = "Marked" ;
//var engine = "Showdown" ;
var backend = "edit.php" ;
//var backend = "edit.gy" ;
//var backend = "edit.sh" ;
var page = {
	name: ""
	, pathname: ""
	, path: ""
	, pathcrc: ""
	, href: ""
	, url: ""
	, data: ""
	, readOnly: false
} ;
var password = "" ;
var salt = "" ;
function doShowdown( data ) {
	var converter = new showdown.Converter({tables: true, strikethrough: true, parseImgDimensions: true, simplifiedAutoLink: true, excludeTrailingPunctuationFromURLs: true, tasklists: true, smoothLivePreview: true}) ;
	return converter.makeHtml( data.replace(/__([^_]*)__/gm, '<u>$1</u>') ) ;
}
function doMarked( data ) {
	//return  marked( data, { sanitize: true } ) ;
	//return  marked( data, { highlight: function(code) { return require('highlight.js').highlightAuto(code).value ; } } ) ;
	if( highlightjs ) {
		return  marked( data.replace(/__([^_]*)__/gm, '<u>$1</u>'), { highlight: function(code) { return hljs.highlightAuto(code).value ; } } ) ;
	} else {
		return  marked( data.replace(/__([^_]*)__/gm, '<u>$1</u>') ) ;
	}
}
function doMarkdown( data ) {
	if( engine == "Showdown" ) { return doShowdown( data ) ; }
	else if( engine == "raw" ) { return data ; }
	else if( engine == "base64" ) { return Base64.encode( data ) ; }
	else { return doMarked( data ) ; }
}
function renderHTML( id, data64 ) {
	document.getElementById(id).innerHTML = "" ;
	data = Base64.decode(data64) ;
	if( page.name.match( /\.md$/ ) ) {
		document.getElementById(id).innerHTML = doMarkdown( data ) ;
	} else {
		document.getElementById(id).innerHTML = data ;
	}
	if( (res = data.match( /^[ ]*\[\/\/\]:[ ]*#[ ]*\([ ]*title:.*\).*$/m ))!=null ) {
		document.title = res[0].replace( /.*\([ ]*title:/, "" ).replace( /[ ]*\).*$/, "" ) ;
	}
	if( (res = data.match( /^[ ]*\[\/\/\]:[ ]*#[ ]*\([ ]*style:.*\).*$/m ))!=null ) {
		switch_style( res[0].replace( /.*\([ ]*style:[ ]*/, "" ).replace( /[ ]*\).*$/, "" ) ) ;
	}
	if( (res = data.match( /^[ ]*\[\/\/\]:[ ]*#[ ]*\([ ]*readonly[ ]*\).*$/m ))!=null ) { page.readOnly = true ; }
}
function doLoad( name ) {
	reg = new RegExp( '^' + separator  ) ;
	name = name.replace( reg, "" ) ;		//name = location.hash.replace( /^#\//, "" ) ;
	reg = null ;
	page.name = name ;
	if( !name.match( /\// ) ) { page.pathname = "./" ; } else { page.pathname = name.replace( /[^\/]+$/, "" ) ; }
	page.path = location.protocol + "//" + location.host + location.pathname.replace( /\/[^\/]*$/,"/" ) ;
	page.pathcrc = crc32(page.path) ;
	page.href = location.protocol + "//" + location.host + location.pathname + separator + page.name ;
	page.script = location.protocol + "//" + location.host + location.pathname ;
	page.url = location.protocol + "//" + location.host + location.pathname.replace( /\/[^\/]*$/,"/" ) + name ;
	page.data = null ;

	if( sessionStorage.getItem( "MDEditor"+page.pathcrc ) ) { password = sessionStorage.getItem( "MDEditor"+page.pathcrc ) ; }
	else { password = "" ; }
	if( sessionStorage.getItem( "MDStyle" ) ) { style = sessionStorage.getItem( "MDStyle" ) ; switch_style( style ) ; }
	
//console.log( page ) ;
	loadPage( page.url
		, function(res,s) { 
			data = res ;
			salt = s ;
			if( data.match( /^!PASS/ ) ) {
				if( password=="" ) { doPass() ; }
				data = data.replace( /^!PASS/, "" ) ;
				data = sjcl.decrypt( password, data ) ;
			}
			page.data = Base64.encode( data ) ;
			document.title = page.name ;
			renderHTML( "content", page.data ) ;
		}
		, function() { 
			if( page.name.match( /\.md$/ ) ) {
				swal( "Oops", "Something went wrong!<br/>Unable to open <u>" + name + "</u> file", "error" ) ;
				page.data = Base64.encode( "\n[//]: # (title:"+page.name+")\n" ) ;
				renderHTML( "content", page.data ) ;
				switchToEditor() ;
			} else {
				doLoad( page.name+".md" ) ;
			}
		} 
	) ;
}
function switch_style(css_title) {
	if( css_title == null ) {
		var n = style_list.indexOf( style ) + 1 ;
		if( n>=style_list.length ) { n = 0 ; }
		style = style_list[n] ;
		n = null ;
	} else {
		if( style_list.indexOf(css_title)==-1 ) {
			loadjscssfile(css_title+".css", "css", css_title) ;
			style_list.push(css_title) ;
		} 
		if( style_list.indexOf(css_title)==-1 ) { return ; }
		style = css_title ; 
	}
var i, link_tag ;

 for (i = 0, link_tag = document.getElementsByTagName("style") ;
    i < link_tag.length ; i++ ) {
    if( link_tag[i].title ) {
      if( link_tag[i].title == "ttxt" ) { link_tag[i].disabled = false ; } else { link_tag[i].disabled = true ; } 
      if (link_tag[i].title == style) {
        link_tag[i].disabled = false ;
      }
    }
  }

  for (i = 0, link_tag = document.getElementsByTagName("link") ;
    i < link_tag.length ; i++ ) {
    if ((link_tag[i].rel.indexOf( "stylesheet" ) != -1) &&
      link_tag[i].title) {
      link_tag[i].disabled = true ;
      if (link_tag[i].title == style) {
        link_tag[i].disabled = false ;
      }
    }
  }/*
 for (i = 0, link_tag = document.getElementsByTagName("style") ;
    i < link_tag.length ; i++ ) {
    if( link_tag[i].title ) {
      if (link_tag[i].title == "ttxt") {
        link_tag[i].disabled = false ;
      }
    }
  }*/
  link_tag = null ;
  sessionStorage.setItem( "MDStyle", style ) ;
}
function switchToEditor() {
	if( page.readOnly ) { return ; }
	pct = document.documentElement.scrollTop/ document.documentElement.scrollHeight ;
	document.getElementById("content").style.display = 'none' ;
	document.getElementById('ttxt').value = '' ;
	data = Base64.decode( page.data ) ;
	document.getElementById('ttxt').value = data ;
	document.getElementById("editor").style.display = 'block' ;
	n = Math.round( pct*data.length ) ;
	textareaSelect( document.getElementById('ttxt'), n, n ) ;
	force_scroll( document.getElementById('ttxt'), pct ) ;
	document.getElementById('ttxt').click() ;
}
function switchToContent() {
	pct = document.documentElement.scrollTop/ document.documentElement.scrollHeight ;
	page.data = Base64.encode( document.getElementById('ttxt').value ) ;
	renderHTML( "content", page.data ) ;
	document.getElementById("editor").style.display = 'none' ;
	document.getElementById("content").style.display = 'block' ;
	force_scroll( document.documentElement, pct ) ;
}
function doSave() { 
	if( page!=null ) {
		if( password == "" ) {
			data = Base64.encode(document.getElementById('ttxt').value) ;
		} else {
			data = Base64.encode( "!PASS" + sjcl.encrypt( password, document.getElementById('ttxt').value ) ) ;
		}
		savePage( backend
			, page.name
			, data
			, function() { swal( 'Good job!', 'Everything is fine!', 'success' ) ; switchToContent() ; }
			, function() { swal( "Oops", "Something went wrong while saving page<br/><u>"+page.name+"</u> !", "error" ) ; } 
		) ; 
	}
}
function doHash( h, t ) {
	t = t || true ;
	reg = new RegExp( '^' + separator  ) ;
	if( !h.match( reg ) ) { h = separator + h ; }
	reg = null ;
	location.assign( page.script + h ) ;
	location.reload( t ) ;
}
function doJump( ev ) {
	url = ev.hash ;
	if( url == "" ) {
		url = ev.attributes[0].nodeValue ;
		if( !url.match( /^http[s]?:\/\// ) ) {
			if( url.match( /\.md$/ ) ) {
				ev.removeAttribute('href');
				url = page.script + separator + url ;
				window.open(url, "_self", "", true );
				return true ;
			} else {
				url = page.path + '/' + url ;
			}
			url = url.replace( /\/\//g, "/" ) ;
		}
		location.assign( url ) ;
		return false;
	} else {
		doHash( url ) ;
		return false ;
	}
}
function doHelp() {
  swal({
  width: 600,
  title: 'Help page?',
  html: '<ul style="text-align:left;"><li>To switch from page viewer to page editor, just triple-click</li><li>To protect the page with password ALT+p</li><li>To save the page press ALT+o</li><li>To switch back to the viewer press escape key</li></ul>'
  });
}
function doPass() {
	password = window.prompt( "Protected mode. Please enter the password:", password ) ;
	if( password == null ) { password = "" ; }
	if( password == "" ) {
		sessionStorage.removeItem( "MDEditor"+page.pathcrc ) ;
	} else {
		sessionStorage.setItem( "MDEditor"+page.pathcrc, password ) ;
	}
}
function doScroll(el) {
	pos = el.scrollTop/el.scrollHeight ;
	force_scroll( document.documentElement, pos ) ;
}
function init() {
	if( location.hash=="" ) { 
		location.replace( location.href + separator + "index.md" ) ; 
	} else {
		doLoad( location.hash ) ;
	}
	var Params = getParams() ;
	if( Params.style ) { switch_style( Params.style ) ; }
	else { switch_style( "original" ) ; }
	if( Params.engine ) { engine = Params.engine ; }
	if( Params.backend ) { 
		backend = Params.backend ;
		if( !backend.match( /\./ ) ) {  backend = "edit." + Params.backend ; }
		if( backend=="edit.groovy" ) { backend = "edit.gy" ; } 
	}
	
	Params = null ;
}
</script>
<style type="text/css" title="ttxt">
#content {
  padding: 3%;
}
#ttxt {
  position: fixed;
  display: inline-block;
  left: 3px;
  top: 0px;
  resize: vertical;
  height: 100%;
  width: 49%;
  border: none;
  border-right: 1px solid #ccc;
  background-color: #f6f6f6;
  font-size: 14px;
  font-family: 'Monaco', courier, monospace;
  padding: 20px;
}
textarea, #editor div {
  display: inline-block;
  width: 49%;
  height: 100%;
  vertical-align: top;
  box-sizing: border-box;
  padding: 0 20px;
}
#editor {
  position: relative;
  left: 50%;
}
code {
  overflow-x: visible;
  overflow-wrap: break-word;
}
pre {
  overflow-x: auto;
  overflow-wrap: break-word;
}
//a { pointer-events:none ; }
</style>

</head>
<body onLoad="init();">

<div id="editor" style="display: none;">
  <textarea id="ttxt" v-on:click="update" @keyup.alt.f1="doHelp();return false;" @keyup.alt.80="doPass();" @keyup.alt.83="doSave();" @keyup.alt.84="switch_style(null);" @keyup.esc="switchToContent();" :value="input" @input="update" onScroll="doScroll(this);return false;"></textarea>
  <div v-html="compiledMarkdown"></div>
</div>

<div id="content"></div>
<!-- onDblClick="switchToEditor();" -->

<script type="text/javascript">
new Vue({
  el: '#editor',
  data: {
    input: '[comment]: <> (This is a comment, it will not be included)'
  },
  computed: {
    compiledMarkdown: function () {
      return doMarkdown( this.input )
    }
  },
  methods: {
    update: _.debounce(function (e) {
      //document.getElementById('ttxt').style.height = document.getElementById("editor").scrollHeight + 'px' ;
      this.input = e.target.value
    }, 300)
  }
}) ;

document.getElementById("content").onclick = function(ev) {
	if( ev.srcElement.nodeName == "A" ) {
		doJump( ev.srcElement ) ;
	}
}
window.onhashchange = function() {
	if( document.getElementById('content').style.display=='none' ) { switchToContent() ; return false ; } 
	else if (window.location.hash != '#undefined') {
	    doHash( window.location.hash ) ;
	}
}
window.addEventListener('click', function (evt) {
    if (evt.detail === 3) {
        switchToEditor() ;
    }
});
/*
window.document.getElementById("ttxt").addEventListener("scroll", function (event) {
    var scroll = this.scrollY;
//    console.log(scroll)
});*/
</script>


</body>
</html>
